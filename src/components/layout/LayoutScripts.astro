---
// Scripts for mobile menu and page transitions
---

<script defer>
  // Mobile menu toggle with animations
  (function () {
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuIconOpen = document.getElementById('mobile-menu-icon-open');
    const mobileMenuIconClose = document.getElementById('mobile-menu-icon-close');

    if (!mobileMenuButton || !mobileMenu || !mobileMenuIconOpen || !mobileMenuIconClose) return;

    function toggleMenu() {
      const isOpen = !mobileMenu.classList.contains('hidden');

      if (isOpen) {
        // Close menu with animation
        mobileMenu.classList.remove('mobile-menu-open');
        mobileMenuButton.setAttribute('aria-expanded', 'false');

        // Hide menu items with stagger (reverse order)
        const menuItems = Array.from(mobileMenu.querySelectorAll('.mobile-menu-item')).reverse();
        menuItems.forEach((item, index) => {
          setTimeout(() => {
            item.classList.remove('mobile-menu-item-visible');
          }, index * 30);
        });

        // Animate icon transition - close icon fades out and rotates
        mobileMenuIconClose.classList.add('opacity-0', 'rotate-90');

        // Switch to open icon after close icon animation
        setTimeout(() => {
          mobileMenuIconClose.classList.add('hidden');
          mobileMenuIconOpen.classList.remove('hidden');
          // Trigger reflow for animation
          void mobileMenuIconOpen.offsetWidth;
          mobileMenuIconOpen.classList.remove('opacity-0', 'rotate-90');
        }, 150);

        // Hide menu after animation
        setTimeout(() => {
          mobileMenu.classList.add('hidden');
          document.body.classList.remove('menu-open');
        }, 300);
      } else {
        // Open menu
        mobileMenu.classList.remove('hidden');
        mobileMenuButton.setAttribute('aria-expanded', 'true');

        // Animate icon transition
        mobileMenuIconOpen.classList.add('opacity-0', 'rotate-90');
        setTimeout(() => {
          mobileMenuIconOpen.classList.add('hidden');
          mobileMenuIconClose.classList.remove('hidden');
          // Trigger reflow for animation
          void mobileMenuIconClose.offsetWidth;
          mobileMenuIconClose.classList.remove('opacity-0', 'rotate-90');
        }, 150);

        // Trigger menu slide animation on next frame
        requestAnimationFrame(() => {
          mobileMenu.classList.add('mobile-menu-open');

          // Animate menu items with stagger
          const menuItems = mobileMenu.querySelectorAll('.mobile-menu-item');
          menuItems.forEach((item, index) => {
            setTimeout(
              () => {
                item.classList.add('mobile-menu-item-visible');
              },
              100 + index * 50
            );
          });
        });

        document.body.classList.add('menu-open');
      }
    }

    mobileMenuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    // Close menu when clicking on a link
    const mobileMenuLinks = mobileMenu.querySelectorAll('.mobile-menu-link');
    mobileMenuLinks.forEach((link) => {
      link.addEventListener('click', () => {
        // Small delay to allow navigation
        setTimeout(() => {
          toggleMenu();
        }, 100);
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (
        !mobileMenu.contains(target) &&
        !mobileMenuButton.contains(target) &&
        !mobileMenu.classList.contains('hidden')
      ) {
        toggleMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
        toggleMenu();
      }
    });

    // Close menu on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768 && !mobileMenu.classList.contains('hidden')) {
        toggleMenu();
      }
    });
  })();

  // Page transition animation
  (function () {
    const mainContent = document.getElementById('main-content');

    // Add fade-in animation on initial page load
    if (mainContent) {
      // Small delay to ensure smooth initial load
      requestAnimationFrame(() => {
        mainContent.classList.add('page-enter');
      });
    }

    // Handle Astro view transitions (if enabled)
    if (document.startViewTransition) {
      // Use native view transitions API if available
      document.addEventListener('astro:before-preparation', () => {
        if (mainContent) {
          mainContent.classList.add('page-exit');
        }
      });

      document.addEventListener('astro:page-load', () => {
        if (mainContent) {
          mainContent.classList.remove('page-exit');
          requestAnimationFrame(() => {
            mainContent.classList.add('page-enter');
          });
        }
      });
    } else {
      // Fallback for browsers without view transitions
      document.addEventListener('astro:page-load', () => {
        if (mainContent) {
          mainContent.classList.remove('page-enter', 'page-exit');
          // Trigger reflow to restart animation
          void mainContent.offsetWidth;
          requestAnimationFrame(() => {
            mainContent.classList.add('page-enter');
          });
        }
      });

      document.addEventListener('astro:before-preparation', () => {
        if (mainContent) {
          mainContent.classList.add('page-exit');
        }
      });
    }
  })();
</script>
