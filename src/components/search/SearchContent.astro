---
import { getLocalizedPath, type Locale } from '../../utils/i18n';
import type { CollectionEntry } from 'astro:content';
import { calculateReadingTime } from '../../utils/readingTime';

interface Props {
  posts: CollectionEntry<'notes'>[];
  locale: Locale;
  t: any;
}

const { posts, locale, t } = Astro.props;

// Get Giscus config from environment variables
const giscusConfig = {
  repo: import.meta.env.PUBLIC_GISCUS_REPO || '',
  category: import.meta.env.PUBLIC_GISCUS_CATEGORY || '',
  categoryId: import.meta.env.PUBLIC_GISCUS_CATEGORY_ID || '',
};

// Prepare posts data for client-side search
const postsData = posts.map((post) => {
  const postSlug = post.slug.replace(/\/id$|\/en$/, '');
  const postPath = getLocalizedPath(`/notes/${postSlug}`, locale);

  return {
    slug: postSlug,
    path: postPath,
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate.toISOString(),
    tags: post.data.tags || [],
    author: post.data.author,
    readingTime: calculateReadingTime(post.body),
  };
});

// Serialize for script
const postsDataJson = JSON.stringify(postsData);
const localeStr = locale;
const tJson = JSON.stringify(t);
const giscusConfigJson = JSON.stringify(giscusConfig);
---

<div class="mb-8">
  <input
    type="text"
    id="search-input"
    placeholder={t.search.placeholder}
    class="w-full rounded-lg border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:focus:border-blue-400 dark:focus:ring-blue-400"
  />
</div>

<div id="search-results" class="space-y-4">
  <!-- Results will be inserted here -->
</div>

<div id="no-results" class="hidden text-center text-gray-600 dark:text-gray-400">
  {t.search.noResults}
</div>

<div id="search-loading" class="hidden text-center text-gray-500 dark:text-gray-400">
  <div class="inline-flex items-center gap-2">
    <svg
      class="h-5 w-5 animate-spin"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
      ></circle>
      <path
        class="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      ></path>
    </svg>
    <span>Searching...</span>
  </div>
</div>

<script define:vars={{ postsDataJson, localeStr, tJson, giscusConfigJson }}>
  const postsData = JSON.parse(postsDataJson);
  const locale = localeStr;
  const t = JSON.parse(tJson);
  const giscusConfig = JSON.parse(giscusConfigJson);

  function searchPosts(query, searchInput, searchResults, noResults, searchLoading) {
    // Hide loading indicator
    if (searchLoading) {
      searchLoading.classList.add('hidden');
    }

    if (!query || !query.trim()) {
      searchResults.innerHTML = '';
      noResults.classList.add('hidden');
      return;
    }

    const lowerQuery = query.toLowerCase();
    const filtered = postsData.filter((post) => {
      const titleMatch = post.title && post.title.toLowerCase().includes(lowerQuery);
      const descMatch = post.description && post.description.toLowerCase().includes(lowerQuery);
      const tagMatch =
        post.tags && post.tags.some((tag) => tag && tag.toLowerCase().includes(lowerQuery));
      return titleMatch || descMatch || tagMatch;
    });

    if (filtered.length === 0) {
      searchResults.innerHTML = '';
      noResults.classList.remove('hidden');
      return;
    }

    noResults.classList.add('hidden');

    const dateLocale = locale === 'id' ? 'id-ID' : 'en-US';

    const resultsHTML = filtered
      .map((post) => {
        const tagsHTML =
          post.tags && post.tags.length > 0
            ? `<div class="mt-4 flex flex-wrap gap-2">
            ${post.tags
              .map(
                (tag) =>
                  `<span class="rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900 dark:text-blue-200">${tag}</span>`
              )
              .join('')}
          </div>`
            : '';

        return `
        <article class="rounded-lg border border-gray-200 bg-white p-6 transition-shadow hover:shadow-lg dark:border-gray-800 dark:bg-gray-800">
          <h3 class="mb-2 text-xl font-semibold">
            <a href="${post.path}" class="hover:text-blue-600 dark:hover:text-blue-400">
              ${post.title || ''}
            </a>
          </h3>
          <p class="mb-4 text-gray-600 dark:text-gray-400">${post.description || ''}</p>
          <div class="mb-4 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
            <time>
              ${new Date(post.pubDate).toLocaleDateString(dateLocale, {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </time>
            <span>•</span>
            <span>${
              post.readingTime < 1
                ? t.notes.underOneMinute
                : `${Math.ceil(post.readingTime)} ${t.notes.minRead}`
            }</span>
            <span>•</span>
            <span class="giscus-stats inline-flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400" data-pathname="${post.path}" data-locale="${locale}">
              <span class="giscus-reaction inline-flex items-center gap-1">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                <span class="reaction-count">-</span>
              </span>
              <span class="giscus-comment inline-flex items-center gap-1">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span class="comment-count">-</span>
              </span>
            </span>
          </div>
          <div class="flex items-center justify-end">
            <a
              href="${post.path}"
              class="text-sm font-medium text-blue-600 hover:underline dark:text-blue-400"
            >
              ${t.notes.readMore} →
            </a>
          </div>
          ${tagsHTML}
        </article>
      `;
      })
      .join('');

    searchResults.innerHTML = `
      <p class="mb-4 text-gray-600 dark:text-gray-400">
        ${filtered.length} ${t.search.results}
      </p>
      <div class="space-y-4">
        ${resultsHTML}
      </div>
    `;

    // Load Giscus stats for all results
    initGiscusStats();
  }

  async function loadGiscusStats(element) {
    const pathname = element.getAttribute('data-pathname');
    if (!pathname) return;

    try {
      // Use Giscus API to get discussion by pathname
      if (!giscusConfig.repo || !giscusConfig.category || !giscusConfig.categoryId) {
        element.style.display = 'none';
        return;
      }

      const response = await fetch(
        `https://giscus.app/api/discussions?repo=${encodeURIComponent(giscusConfig.repo)}&category=${encodeURIComponent(giscusConfig.category)}&categoryId=${giscusConfig.categoryId}&mapping=pathname&term=${encodeURIComponent(pathname)}`
      );

      if (!response.ok) {
        element.style.display = 'none';
        return;
      }

      const data = await response.json();

      // Handle different response formats from Giscus API
      // Response can be: { discussion: { reactionCount: ..., totalCommentCount: ... } } or array of such objects
      let reactionCount = 0;
      let commentCount = 0;

      if (Array.isArray(data) && data.length > 0) {
        // Giscus API returns array of discussion objects
        const item = data[0];
        const discussion = item.discussion || item;
        reactionCount = discussion.reactionCount || 0;
        commentCount = discussion.totalCommentCount || 0;
      } else if (data && typeof data === 'object') {
        // Single discussion object - check for nested discussion property
        const discussion = data.discussion || data;
        reactionCount = discussion.reactionCount || 0;
        commentCount = discussion.totalCommentCount || 0;
      }

      // Update reaction count
      const reactionCountElement = element.querySelector('.reaction-count');
      if (reactionCountElement) {
        reactionCountElement.textContent = reactionCount.toString();
      }

      // Update comment count
      const commentCountElement = element.querySelector('.comment-count');
      if (commentCountElement) {
        commentCountElement.textContent = commentCount.toString();
      }
    } catch (error) {
      // Silently fail - hide element on error
      element.style.display = 'none';
    }
  }

  // Load Giscus stats (reactions and comments) for all elements on the page
  function initGiscusStats() {
    const elements = document.querySelectorAll('.giscus-stats');
    // Convert NodeList to Array to ensure forEach is available
    Array.from(elements).forEach((element) => {
      loadGiscusStats(element);
    });
  }

  // Debounce utility function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function initSearch() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const noResults = document.getElementById('no-results');
    const searchLoading = document.getElementById('search-loading');

    if (!searchInput || !searchResults || !noResults) {
      return;
    }

    // Create debounced search function with 500ms delay
    const debouncedSearch = debounce((query) => {
      searchPosts(query, searchInput, searchResults, noResults, searchLoading);
    }, 500);

    // Handle input events
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();

      // Show loading indicator if there's a query
      if (query && searchLoading) {
        searchResults.innerHTML = '';
        noResults.classList.add('hidden');
        searchLoading.classList.remove('hidden');
      } else if (searchLoading) {
        searchLoading.classList.add('hidden');
      }

      // Trigger debounced search
      debouncedSearch(query);
    });

    // Handle paste events (for better UX)
    searchInput.addEventListener('paste', (e) => {
      // Small delay to get the pasted value
      setTimeout(() => {
        const query = e.target.value.trim();
        if (query && searchLoading) {
          searchResults.innerHTML = '';
          noResults.classList.add('hidden');
          searchLoading.classList.remove('hidden');
        }
        debouncedSearch(query);
      }, 10);
    });

    // Search on page load if there's a query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');
    if (queryParam) {
      searchInput.value = queryParam;
      searchPosts(queryParam, searchInput, searchResults, noResults, searchLoading);
    }
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
</script>

<style>
  .giscus-stats {
    transition: opacity 0.2s;
  }

  .giscus-stats[style*='display: none'] {
    display: none !important;
  }

  .giscus-reaction,
  .giscus-comment {
    display: inline-flex;
    align-items: center;
  }
</style>
