---
interface Props {
  pathname: string;
  locale?: 'id' | 'en';
}

const { pathname, locale = 'id' } = Astro.props;
---

<span
  class="giscus-stats inline-flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400"
  data-pathname={pathname}
  data-locale={locale}
>
  <span class="giscus-reaction inline-flex items-center gap-1">
    <svg
      class="h-4 w-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      ></path>
    </svg>
    <span class="reaction-count">-</span>
  </span>
  <span class="giscus-comment inline-flex items-center gap-1">
    <svg
      class="h-4 w-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>
    <span class="comment-count">-</span>
  </span>
</span>

<script>
  // @ts-ignore - Astro script tags don't support TypeScript syntax
  async function loadGiscusStats(element) {
    if (!(element instanceof HTMLElement)) return;
    const pathname = element.getAttribute('data-pathname');
    if (!pathname) return;

    try {
      // Use our API route proxy to avoid CORS issues
      const response = await fetch(`/api/giscus-stats?pathname=${encodeURIComponent(pathname)}`);

      let reactionCount = 0;
      let commentCount = 0;

      if (!response.ok) {
        // If 404, show 0 counts instead of hiding
        if (response.status === 404) {
          reactionCount = 0;
          commentCount = 0;
        } else {
          // For other errors, hide the element
          element.style.display = 'none';
          return;
        }
      } else {
        const data = await response.json();

        // createSuccessResponse returns data directly, not wrapped in { success, data }
        reactionCount = data?.reactionCount || 0;
        commentCount = data?.commentCount || 0;
      }

      // Update reaction count
      const reactionCountElement = element.querySelector('.reaction-count');
      if (reactionCountElement) {
        reactionCountElement.textContent = reactionCount.toString();
      }

      // Update comment count
      const commentCountElement = element.querySelector('.comment-count');
      if (commentCountElement) {
        commentCountElement.textContent = commentCount.toString();
      }

      // Debug logging (remove in production if needed)
      // console.log('Giscus stats loaded:', { pathname, reactionCount, commentCount });
    } catch (error) {
      // Debug logging for errors
      // console.error('Error loading Giscus stats:', error);
      // On error, show 0 counts instead of hiding
      const reactionCountElement = element.querySelector('.reaction-count');
      if (reactionCountElement) {
        reactionCountElement.textContent = '0';
      }

      const commentCountElement = element.querySelector('.comment-count');
      if (commentCountElement) {
        commentCountElement.textContent = '0';
      }
    }
  }

  // Load Giscus stats (reactions and comments) for all elements on the page
  function initGiscusStats() {
    const elements = document.querySelectorAll('.giscus-stats');
    // Convert NodeList to Array to ensure forEach is available
    Array.from(elements).forEach((element) => {
      if (element instanceof HTMLElement) {
        loadGiscusStats(element);
      }
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusStats);
  } else {
    initGiscusStats();
  }

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initGiscusStats);
</script>

<style>
  .giscus-stats {
    transition: opacity 0.2s;
  }

  .giscus-stats[style*='display: none'] {
    display: none !important;
  }

  .giscus-reaction,
  .giscus-comment {
    display: inline-flex;
    align-items: center;
  }
</style>
