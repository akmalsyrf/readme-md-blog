---

---

<div id="image-modal" class="image-modal" role="dialog" aria-modal="true" aria-label="Image viewer">
  <button id="image-modal-close" class="image-modal-close" aria-label="Close image viewer">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
  <div class="image-modal-backdrop"></div>
  <div class="image-modal-content">
    <img id="image-modal-img" class="image-modal-img" alt="Full screen image" />
    <p id="image-modal-caption" class="image-modal-caption"></p>
  </div>
</div>

<style>
  .image-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    min-width: 100vw !important;
    min-height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    z-index: 99999 !important;
    display: none;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.95) !important;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    overflow: hidden;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
  }

  .image-modal.active {
    display: flex !important;
  }

  .image-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .image-modal-content {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    max-height: 90vh;
    max-width: 95vw;
    padding: 1rem;
  }

  .image-modal-img {
    max-height: 85vh;
    max-width: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
    animation: imageModalFadeIn 0.3s ease-out;
  }

  .image-modal-caption {
    margin-top: 1rem;
    text-align: center;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.9);
    max-width: 42rem;
    padding: 0 1rem;
  }

  .image-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 20;
    display: flex;
    height: 2.5rem;
    width: 2.5rem;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }

  .image-modal-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .image-modal-close:focus {
    outline: none;
    ring: 2px;
    ring-color: rgba(255, 255, 255, 0.5);
  }

  .image-modal-close svg {
    height: 1.5rem;
    width: 1.5rem;
  }

  @keyframes imageModalFadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Make images clickable */
  .prose img,
  .prose picture img {
    cursor: pointer;
    transition:
      transform 0.2s ease,
      opacity 0.2s ease;
  }

  .prose img:hover,
  .prose picture img:hover {
    opacity: 0.9;
    transform: scale(1.02);
  }

  /* Ensure modal is above everything */
  @media (prefers-reduced-motion: no-preference) {
    .image-modal.active {
      animation: fadeIn 0.2s ease-out;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>

<script>
  (function initImageModal() {
    let modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('image-modal-img');
    const modalCaption = document.getElementById('image-modal-caption');
    const closeBtn = document.getElementById('image-modal-close');
    const backdrop = modal?.querySelector('.image-modal-backdrop');

    if (!modal || !modalImg || !closeBtn) return;

    // Modal is already in body via BaseLayout, but ensure it's accessible

    function openModal(imgSrc, altText = '') {
      if (!modal || !modalImg) return;

      modalImg.src = imgSrc;
      modalImg.alt = altText || 'Full screen image';

      if (modalCaption) {
        // Try to find caption from the clicked image's parent
        // First try to find by src attribute, then by currentSrc
        let clickedImg = Array.from(document.querySelectorAll('.prose img')).find((img) => {
          return (
            img.src === imgSrc || img.getAttribute('src') === imgSrc || img.currentSrc === imgSrc
          );
        });

        // If not found, try to find by srcset (for picture elements)
        if (!clickedImg) {
          clickedImg = Array.from(document.querySelectorAll('.prose picture img')).find((img) => {
            const picture = img.closest('picture');
            const source = picture?.querySelector('source[type="image/webp"]');
            const srcset = source?.getAttribute('srcset');
            return srcset === imgSrc || img.src === imgSrc || img.currentSrc === imgSrc;
          });
        }

        if (clickedImg) {
          // Look for caption in parent div (usually the wrapper div we added)
          const parentDiv = clickedImg.closest('div');
          if (parentDiv) {
            // Look for paragraph with em (italic) or just paragraph after picture
            const captionP = parentDiv.querySelector('p em') || parentDiv.querySelector('p');
            if (captionP && captionP.textContent.trim()) {
              modalCaption.textContent = captionP.textContent.trim();
              modalCaption.style.display = 'block';
            } else {
              // Try to find caption in next sibling
              const nextP = parentDiv.nextElementSibling;
              if (nextP && nextP.tagName === 'P' && nextP.textContent.trim()) {
                modalCaption.textContent = nextP.textContent.trim();
                modalCaption.style.display = 'block';
              } else {
                modalCaption.style.display = 'none';
              }
            }
          } else {
            modalCaption.textContent = altText || '';
            modalCaption.style.display = altText ? 'block' : 'none';
          }
        } else {
          modalCaption.textContent = altText || '';
          modalCaption.style.display = altText ? 'block' : 'none';
        }
      }

      // Force modal to be on top
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.right = '0';
      modal.style.bottom = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.zIndex = '99999';
      modal.style.margin = '0';
      modal.style.padding = '0';

      // Show modal
      modal.classList.add('active');
      modal.style.display = 'flex';

      // Hide header and other high z-index elements
      const header = document.querySelector('header');
      if (header) {
        header.style.visibility = 'hidden';
        header.style.pointerEvents = 'none';
      }

      // Hide chatbot button if exists
      const chatButton = document.getElementById('chatbot-toggle');
      if (chatButton) {
        chatButton.style.visibility = 'hidden';
        chatButton.style.pointerEvents = 'none';
      }

      // Prevent body scroll
      const scrollY = window.scrollY;
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollY}px`;
      document.body.style.width = '100%';
      document.body.style.height = '100%';
    }

    function closeModal() {
      if (!modal) return;
      modal.classList.remove('active');
      modal.style.display = 'none';

      // Show header and other elements again
      const header = document.querySelector('header');
      if (header) {
        header.style.visibility = '';
        header.style.pointerEvents = '';
      }

      // Show chatbot button again
      const chatButton = document.getElementById('chatbot-toggle');
      if (chatButton) {
        chatButton.style.visibility = '';
        chatButton.style.pointerEvents = '';
      }

      // Restore body scroll
      const scrollY = document.body.style.top;
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      document.body.style.top = '';

      if (scrollY) {
        window.scrollTo(0, parseInt(scrollY || '0') * -1);
      }
    }

    // Close button
    closeBtn?.addEventListener('click', closeModal);

    // Backdrop click
    backdrop?.addEventListener('click', (e) => {
      if (e.target === backdrop) {
        closeModal();
      }
    });

    // ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.classList.contains('active')) {
        closeModal();
      }
    });

    // Attach click handlers to all images in prose content
    function attachImageHandlers() {
      // Handle both direct images and images inside picture elements
      const images = document.querySelectorAll('.prose img');
      const pictures = document.querySelectorAll('.prose picture');

      // Handle direct images
      images.forEach((img) => {
        // Skip if already has handler or if inside a picture (will handle separately)
        if (img.dataset.modalAttached === 'true' || img.closest('picture')) return;

        img.dataset.modalAttached = 'true';

        img.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const imgElement = img;
          const src = imgElement.src || imgElement.getAttribute('src') || '';

          // Get alt text
          const alt = imgElement.alt || imgElement.getAttribute('alt') || '';

          if (src) {
            openModal(src, alt);
          }
        });
      });

      // Handle picture elements (click on picture or img inside)
      pictures.forEach((picture) => {
        if (picture.dataset.modalAttached === 'true') return;

        picture.dataset.modalAttached = 'true';
        const img = picture.querySelector('img');

        if (!img) return;

        const handleClick = (e) => {
          e.preventDefault();
          e.stopPropagation();

          // Use currentSrc which gives us the actual loaded image (webp if supported, otherwise fallback)
          const imgSrc = img.currentSrc || img.src || img.getAttribute('src') || '';
          const alt = img.alt || img.getAttribute('alt') || '';

          if (imgSrc) {
            openModal(imgSrc, alt);
          }
        };

        picture.addEventListener('click', handleClick);
        img.addEventListener('click', handleClick);
      });
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attachImageHandlers);
    } else {
      attachImageHandlers();
    }

    // Re-attach handlers when content changes (for dynamic content)
    const observer = new MutationObserver(() => {
      attachImageHandlers();
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  })();
</script>
