---
import { getLocalizedPath, type Locale } from '../../utils/i18n';
import type { CollectionEntry } from 'astro:content';
import { calculateReadingTime } from '../../utils/readingTime';

interface Props {
  posts: CollectionEntry<'notes'>[];
  locale: Locale;
  t: any;
}

const { posts, locale, t } = Astro.props;

// Prepare posts data for client-side search
const postsData = posts.map((post) => {
  const postSlug = post.slug.replace(/\/id$|\/en$/, '');
  const postPath = getLocalizedPath(`/notes/${postSlug}`, locale);

  return {
    slug: postSlug,
    path: postPath,
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate.toISOString(),
    tags: post.data.tags || [],
    author: post.data.author,
    readingTime: calculateReadingTime(post.body),
  };
});

// Serialize for script
const postsDataJson = JSON.stringify(postsData);
const localeStr = locale;
const tJson = JSON.stringify(t);
---

<div class="mb-8">
  <input
    type="text"
    id="search-input"
    placeholder={t.search.placeholder}
    class="w-full rounded-lg border border-gray-300 bg-white px-4 py-3 text-gray-900 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:focus:border-blue-400 dark:focus:ring-blue-400"
  />
</div>

<div id="search-results" class="space-y-4">
  <!-- Results will be inserted here -->
</div>

<div id="no-results" class="hidden text-center text-gray-600 dark:text-gray-400">
  {t.search.noResults}
</div>

<script define:vars={{ postsDataJson, localeStr, tJson }}>
  const postsData = JSON.parse(postsDataJson);
  const locale = localeStr;
  const t = JSON.parse(tJson);

  function searchPosts(query, searchInput, searchResults, noResults) {
    if (!query || !query.trim()) {
      searchResults.innerHTML = '';
      noResults.classList.add('hidden');
      return;
    }

    const lowerQuery = query.toLowerCase();
    const filtered = postsData.filter((post) => {
      const titleMatch = post.title && post.title.toLowerCase().includes(lowerQuery);
      const descMatch = post.description && post.description.toLowerCase().includes(lowerQuery);
      const tagMatch =
        post.tags && post.tags.some((tag) => tag && tag.toLowerCase().includes(lowerQuery));
      return titleMatch || descMatch || tagMatch;
    });

    if (filtered.length === 0) {
      searchResults.innerHTML = '';
      noResults.classList.remove('hidden');
      return;
    }

    noResults.classList.add('hidden');

    const dateLocale = locale === 'id' ? 'id-ID' : 'en-US';

    const resultsHTML = filtered
      .map((post) => {
        const tagsHTML =
          post.tags && post.tags.length > 0
            ? `<div class="mt-4 flex flex-wrap gap-2">
            ${post.tags
              .map(
                (tag) =>
                  `<span class="rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900 dark:text-blue-200">${tag}</span>`
              )
              .join('')}
          </div>`
            : '';

        return `
        <article class="rounded-lg border border-gray-200 bg-white p-6 transition-shadow hover:shadow-lg dark:border-gray-800 dark:bg-gray-800">
          <h3 class="mb-2 text-xl font-semibold">
            <a href="${post.path}" class="hover:text-blue-600 dark:hover:text-blue-400">
              ${post.title || ''}
            </a>
          </h3>
          <p class="mb-4 text-gray-600 dark:text-gray-400">${post.description || ''}</p>
          <div class="mb-4 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
            <time>
              ${new Date(post.pubDate).toLocaleDateString(dateLocale, {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </time>
            <span>•</span>
            <span>${
              post.readingTime < 1
                ? t.notes.underOneMinute
                : `${Math.ceil(post.readingTime)} ${t.notes.minRead}`
            }</span>
          </div>
          <div class="flex items-center justify-end">
            <a
              href="${post.path}"
              class="text-sm font-medium text-blue-600 hover:underline dark:text-blue-400"
            >
              ${t.notes.readMore} →
            </a>
          </div>
          ${tagsHTML}
        </article>
      `;
      })
      .join('');

    searchResults.innerHTML = `
      <p class="mb-4 text-gray-600 dark:text-gray-400">
        ${filtered.length} ${t.search.results}
      </p>
      <div class="space-y-4">
        ${resultsHTML}
      </div>
    `;
  }

  function initSearch() {
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const noResults = document.getElementById('no-results');

    if (!searchInput || !searchResults || !noResults) {
      return;
    }

    // Debounce search
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value;
      searchTimeout = setTimeout(
        () => searchPosts(query, searchInput, searchResults, noResults),
        300
      );
    });

    // Search on page load if there's a query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');
    if (queryParam) {
      searchInput.value = queryParam;
      searchPosts(queryParam, searchInput, searchResults, noResults);
    }
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
</script>
