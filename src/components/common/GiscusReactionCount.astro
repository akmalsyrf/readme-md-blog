---
interface Props {
  pathname: string;
  locale?: 'id' | 'en';
}

const { pathname, locale = 'id' } = Astro.props;

// Get Giscus config from environment variables
const giscusConfig = {
  repo: import.meta.env.PUBLIC_GISCUS_REPO || '',
  category: import.meta.env.PUBLIC_GISCUS_CATEGORY || '',
  categoryId: import.meta.env.PUBLIC_GISCUS_CATEGORY_ID || '',
};
---

<span
  class="giscus-stats inline-flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400"
  data-pathname={pathname}
  data-locale={locale}
>
  <span class="giscus-reaction inline-flex items-center gap-1">
    <svg
      class="h-4 w-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
      ></path>
    </svg>
    <span class="reaction-count">-</span>
  </span>
  <span class="giscus-comment inline-flex items-center gap-1">
    <svg
      class="h-4 w-4"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
      ></path>
    </svg>
    <span class="comment-count">-</span>
  </span>
</span>

<script
  define:vars={{
    giscusRepo: giscusConfig.repo,
    giscusCategory: giscusConfig.category,
    giscusCategoryId: giscusConfig.categoryId,
  }}
>
  async function loadGiscusStats(element) {
    const pathname = element.getAttribute('data-pathname');
    if (!pathname) return;

    try {
      // Use Giscus API to get discussion by pathname
      if (!giscusRepo || !giscusCategory || !giscusCategoryId) {
        element.style.display = 'none';
        return;
      }

      const response = await fetch(
        `https://giscus.app/api/discussions?repo=${encodeURIComponent(giscusRepo)}&category=${encodeURIComponent(giscusCategory)}&categoryId=${giscusCategoryId}&mapping=pathname&term=${encodeURIComponent(pathname)}`
      );

      if (!response.ok) {
        element.style.display = 'none';
        return;
      }

      const data = await response.json();

      // Handle different response formats from Giscus API
      // Response can be: { discussion: { reactionCount: ..., totalCommentCount: ... } } or array of such objects
      let reactionCount = 0;
      let commentCount = 0;

      if (Array.isArray(data) && data.length > 0) {
        // Giscus API returns array of discussion objects
        const item = data[0];
        const discussion = item.discussion || item;
        reactionCount = discussion.reactionCount || 0;
        commentCount = discussion.totalCommentCount || 0;
      } else if (data && typeof data === 'object') {
        // Single discussion object - check for nested discussion property
        const discussion = data.discussion || data;
        reactionCount = discussion.reactionCount || 0;
        commentCount = discussion.totalCommentCount || 0;
      }

      // Update reaction count
      const reactionCountElement = element.querySelector('.reaction-count');
      if (reactionCountElement) {
        reactionCountElement.textContent = reactionCount.toString();
      }

      // Update comment count
      const commentCountElement = element.querySelector('.comment-count');
      if (commentCountElement) {
        commentCountElement.textContent = commentCount.toString();
      }
    } catch (error) {
      // Silently fail - hide element on error
      element.style.display = 'none';
    }
  }

  // Load Giscus stats (reactions and comments) for all elements on the page
  function initGiscusStats() {
    const elements = document.querySelectorAll('.giscus-stats');
    // Convert NodeList to Array to ensure forEach is available
    Array.from(elements).forEach((element) => {
      loadGiscusStats(element);
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscusStats);
  } else {
    initGiscusStats();
  }

  // Re-initialize on Astro view transitions
  document.addEventListener('astro:after-swap', initGiscusStats);
</script>

<style>
  .giscus-stats {
    transition: opacity 0.2s;
  }

  .giscus-stats[style*='display: none'] {
    display: none !important;
  }

  .giscus-reaction,
  .giscus-comment {
    display: inline-flex;
    align-items: center;
  }
</style>
