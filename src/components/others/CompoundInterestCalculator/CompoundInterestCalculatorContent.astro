---
import type { Locale } from '../../../utils/i18n';
import Tooltip from '../../common/Tooltip.astro';

interface Props {
  locale: Locale;
  t: any;
}

const { locale, t } = Astro.props;
---

<div class="space-y-6">
  <!-- Input Section -->
  <div
    class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
  >
    <div class="grid gap-4 md:grid-cols-2">
      <div class="md:col-span-2">
        <label
          for="currency"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {t.compoundInterestCalculator.currencyLabel}
        </label>
        <select
          id="currency"
          class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 text-gray-900 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100"
        >
          <option value="IDR">IDR</option>
          <option value="USD">USD</option>
          <option value="SGD">SGD</option>
          <option value="EUR">EUR</option>
          <option value="JPY">JPY</option>
          <option value="MYR">MYR</option>
          <option value="THB">THB</option>
          <option value="AUD">AUD</option>
        </select>
      </div>

      <div>
        <label
          for="principal"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {t.compoundInterestCalculator.principalLabel}
        </label>
        <input
          id="principal"
          type="number"
          inputmode="decimal"
          min="0"
          step="1000"
          class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
          placeholder="0"
        />
        <p id="principal-hint" class="mt-1 text-xs text-gray-500 dark:text-gray-400"></p>
      </div>

      <div>
        <label
          for="monthly"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {t.compoundInterestCalculator.monthlyContributionLabel}
        </label>
        <input
          id="monthly"
          type="number"
          inputmode="decimal"
          min="0"
          step="1000"
          class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
          placeholder="0"
        />
        <p id="monthly-hint" class="mt-1 text-xs text-gray-500 dark:text-gray-400"></p>
      </div>

      <div>
        <label
          for="deposit-increase"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {t.compoundInterestCalculator.depositIncreaseLabel}
        </label>
        <div class="relative">
          <input
            id="deposit-increase"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.1"
            class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 pr-10 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
            placeholder="7"
          />
          <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
            >%</span
          >
        </div>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          {t.compoundInterestCalculator.depositIncreaseHint}
        </p>
      </div>

      <div>
        <label for="rate" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          {t.compoundInterestCalculator.annualRateLabel}
        </label>
        <div class="relative">
          <input
            id="rate"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 pr-10 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
            placeholder="10"
          />
          <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
            >%</span
          >
        </div>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          {t.compoundInterestCalculator.annualRateHint}
        </p>
      </div>

      <div>
        <label for="years" class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">
          {t.compoundInterestCalculator.yearsLabel}
        </label>
        <input
          id="years"
          type="number"
          inputmode="numeric"
          min="0"
          step="1"
          class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
          placeholder="10"
        />
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          {t.compoundInterestCalculator.yearsHint}
        </p>
      </div>

      <div>
        <label
          for="inflation"
          class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          {t.compoundInterestCalculator.inflationLabel}
        </label>
        <div class="relative">
          <input
            id="inflation"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            class="w-full rounded-md border border-gray-300 bg-white px-3 py-2.5 pr-10 text-gray-900 placeholder-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
            placeholder="4"
          />
          <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
            >%</span
          >
        </div>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          {t.compoundInterestCalculator.inflationHint}
        </p>
      </div>
    </div>

    <div class="mt-5 flex flex-wrap gap-3">
      <button
        id="calculate-button"
        class="rounded-md bg-blue-600 px-6 py-2.5 text-sm font-medium text-white transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      >
        {t.compoundInterestCalculator.calculateButton}
      </button>
      <button
        id="reset-button"
        class="rounded-md border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
      >
        {t.compoundInterestCalculator.resetButton}
      </button>
    </div>
  </div>

  <!-- Error -->
  <div
    id="error-message"
    class="hidden rounded-lg border border-red-200 bg-red-50 p-4 text-red-800 dark:border-red-800 dark:bg-red-900/20 dark:text-red-200"
  >
    <p id="error-text"></p>
  </div>

  <!-- Results -->
  <div id="results" class="hidden space-y-6">
    <div
      class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
    >
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
          {t.compoundInterestCalculator.resultsTitle}
        </h2>
        <button
          id="export-button"
          class="hidden rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
        >
          {t.compoundInterestCalculator.exportButton}
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-900">
          <Tooltip
            title={t.compoundInterestCalculator.tooltips.finalAmount.title}
            description={t.compoundInterestCalculator.tooltips.finalAmount.description}
            formula={t.compoundInterestCalculator.tooltips.finalAmount.formula}
            explanation={t.compoundInterestCalculator.tooltips.finalAmount.explanation}
            position="left"
          >
            <p class="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-400">
              {t.compoundInterestCalculator.finalAmount}
              <svg
                class="h-4 w-4 cursor-help text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </p>
          </Tooltip>
          <p id="final-amount" class="mt-1 text-2xl font-bold text-gray-900 dark:text-gray-100"></p>
        </div>
        <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-900">
          <Tooltip
            title={t.compoundInterestCalculator.tooltips.presentValue.title}
            description={t.compoundInterestCalculator.tooltips.presentValue.description}
            formula={t.compoundInterestCalculator.tooltips.presentValue.formula}
            explanation={t.compoundInterestCalculator.tooltips.presentValue.explanation}
            position="center"
          >
            <p class="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-400">
              {t.compoundInterestCalculator.presentValue}
              <svg
                class="h-4 w-4 cursor-help text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </p>
          </Tooltip>
          <p id="present-value" class="mt-1 text-2xl font-bold text-blue-600 dark:text-blue-400">
          </p>
        </div>
        <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-900">
          <Tooltip
            title={t.compoundInterestCalculator.tooltips.totalContributions.title}
            description={t.compoundInterestCalculator.tooltips.totalContributions.description}
            formula={t.compoundInterestCalculator.tooltips.totalContributions.formula}
            explanation={t.compoundInterestCalculator.tooltips.totalContributions.explanation}
            position="center"
          >
            <p class="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-400">
              {t.compoundInterestCalculator.totalContributions}
              <svg
                class="h-4 w-4 cursor-help text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </p>
          </Tooltip>
          <p id="total-contrib" class="mt-1 text-xl font-semibold text-gray-900 dark:text-gray-100">
          </p>
        </div>
        <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-900">
          <Tooltip
            title={t.compoundInterestCalculator.tooltips.totalInterest.title}
            description={t.compoundInterestCalculator.tooltips.totalInterest.description}
            formula={t.compoundInterestCalculator.tooltips.totalInterest.formula}
            explanation={t.compoundInterestCalculator.tooltips.totalInterest.explanation}
            position="right"
          >
            <p class="flex items-center gap-1 text-sm text-gray-600 dark:text-gray-400">
              {t.compoundInterestCalculator.totalInterest}
              <svg
                class="h-4 w-4 cursor-help text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </p>
          </Tooltip>
          <p
            id="total-interest"
            class="mt-1 text-xl font-semibold text-gray-900 dark:text-gray-100"
          >
          </p>
        </div>
      </div>

      <div
        class="mt-5 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="flex items-center justify-between">
          <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
            {t.compoundInterestCalculator.interestShare}
          </p>
          <p id="interest-share" class="text-sm text-gray-600 dark:text-gray-400"></p>
        </div>
        <div class="mt-2 h-3 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700">
          <div id="interest-bar" class="h-full bg-blue-600" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div
      class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
    >
      <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-gray-100">
        {t.compoundInterestCalculator.breakdownTitle}
      </h2>
      <div id="breakdown" class="space-y-2"></div>
    </div>
  </div>
</div>

<script
  define:vars={{
    locale,
    translations: {
      invalidInput: t.compoundInterestCalculator.invalidInput,
      breakdownLabels: t.compoundInterestCalculator.breakdownLabels,
      exportLabels: t.compoundInterestCalculator.exportLabels,
      exportButton: t.compoundInterestCalculator.exportButton,
      exportSuccess: t.compoundInterestCalculator.exportSuccess,
      exportError: t.compoundInterestCalculator.exportError,
    },
  }}
>
  function initCompoundInterestCalculator() {
    const currencyEl = document.getElementById('currency');
    const principalEl = document.getElementById('principal');
    const monthlyEl = document.getElementById('monthly');
    const depositIncreaseEl = document.getElementById('deposit-increase');
    const rateEl = document.getElementById('rate');
    const yearsEl = document.getElementById('years');
    const inflationEl = document.getElementById('inflation');
    const calcBtn = document.getElementById('calculate-button');
    const resetBtn = document.getElementById('reset-button');

    const errorBox = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    const results = document.getElementById('results');
    const finalAmountEl = document.getElementById('final-amount');
    const presentValueEl = document.getElementById('present-value');
    const totalContribEl = document.getElementById('total-contrib');
    const totalInterestEl = document.getElementById('total-interest');
    const interestShareEl = document.getElementById('interest-share');
    const interestBarEl = document.getElementById('interest-bar');
    const breakdownEl = document.getElementById('breakdown');
    const exportBtn = document.getElementById('export-button');

    const principalHint = document.getElementById('principal-hint');
    const monthlyHint = document.getElementById('monthly-hint');

    // Store yearly data for export
    let yearlyData = [];

    if (
      !currencyEl ||
      !principalEl ||
      !monthlyEl ||
      !depositIncreaseEl ||
      !rateEl ||
      !yearsEl ||
      !inflationEl ||
      !calcBtn ||
      !resetBtn ||
      !errorBox ||
      !errorText ||
      !results ||
      !finalAmountEl ||
      !presentValueEl ||
      !totalContribEl ||
      !totalInterestEl ||
      !interestShareEl ||
      !interestBarEl ||
      !breakdownEl ||
      !exportBtn ||
      !principalHint ||
      !monthlyHint
    ) {
      setTimeout(initCompoundInterestCalculator, 100);
      return;
    }

    // Defaults (similar to common calculator presets)
    currencyEl.value = 'IDR';
    principalEl.value = '10000000';
    monthlyEl.value = '1000000';
    depositIncreaseEl.value = '7';
    rateEl.value = '10';
    yearsEl.value = '10';
    inflationEl.value = '4';

    const localeTag = locale === 'id' ? 'id-ID' : 'en-US';

    function getMoneyFormatter() {
      const currency = currencyEl.value || 'IDR';
      return new Intl.NumberFormat(localeTag, {
        style: 'currency',
        currency,
        maximumFractionDigits: currency === 'JPY' ? 0 : 0,
      });
    }

    function formatMoney(value) {
      const fmt = getMoneyFormatter();
      const safe = Number.isFinite(value) ? value : 0;
      return fmt.format(safe);
    }

    function parseNumber(el) {
      const raw = String(el.value ?? '').trim();
      const n = Number(raw);
      return Number.isFinite(n) ? n : NaN;
    }

    function showError(message) {
      errorText.textContent = message;
      errorBox.classList.remove('hidden');
    }

    function hideError() {
      errorBox.classList.add('hidden');
    }

    function updateHints() {
      const p = parseNumber(principalEl);
      const m = parseNumber(monthlyEl);
      principalHint.textContent = Number.isFinite(p) ? formatMoney(p) : '';
      monthlyHint.textContent = Number.isFinite(m) ? formatMoney(m) : '';
    }

    function calculate() {
      hideError();

      const principal = parseNumber(principalEl);
      const monthly = parseNumber(monthlyEl);
      const depositIncreasePct = Number.isFinite(parseNumber(depositIncreaseEl))
        ? parseNumber(depositIncreaseEl)
        : 7;
      const annualRatePct = parseNumber(rateEl);
      const years = parseNumber(yearsEl);
      const inflationPct = parseNumber(inflationEl);

      if (
        !Number.isFinite(principal) ||
        !Number.isFinite(monthly) ||
        !Number.isFinite(annualRatePct) ||
        !Number.isFinite(years) ||
        !Number.isFinite(inflationPct) ||
        principal < 0 ||
        monthly < 0 ||
        depositIncreasePct < 0 ||
        annualRatePct < 0 ||
        years < 0 ||
        inflationPct < 0
      ) {
        showError(translations.invalidInput);
        results.classList.add('hidden');
        return;
      }

      const r = annualRatePct / 100;
      const g = depositIncreasePct / 100; // annual increase in monthly contribution
      const n = 12; // monthly compounding
      const t = years;
      const periods = Math.round(n * t);
      const i = n === 0 ? 0 : r / n;
      const growth12 = Math.pow(1 + i, 12);
      const inflationRate = inflationPct / 100;

      // FV with contributions increasing each year: monthly in year y = monthly * (1+g)^y
      let fv = principal;
      let totalContributions = principal;
      yearlyData = []; // Reset yearly data

      if (i > 0) {
        for (let y = 0; y < years; y++) {
          const monthlyThisYear = monthly * Math.pow(1 + g, y);
          const yearlyContrib = 12 * monthlyThisYear;
          const startingBalance = fv;

          // Calculate FV at end of year: FV = PV * (1+i)^12 + PMT * (((1+i)^12 - 1) / i)
          const fvBeforeContrib = fv * growth12;
          const contribFV = monthlyThisYear * ((growth12 - 1) / i);
          const endingBalance = fvBeforeContrib + contribFV;
          const interestEarned = endingBalance - startingBalance - yearlyContrib;

          // Calculate present value for this year: PV = FV / (1 + inflation_rate)^year
          let presentValue = endingBalance;
          if (inflationRate > 0 && y + 1 > 0) {
            presentValue = endingBalance / Math.pow(1 + inflationRate, y + 1);
          }

          fv = endingBalance;
          totalContributions += yearlyContrib;

          yearlyData.push({
            year: y + 1,
            startingBalance: startingBalance,
            monthlyContribution: monthlyThisYear,
            yearlyContributions: yearlyContrib,
            interestEarned: interestEarned,
            endingBalance: endingBalance,
            presentValue: presentValue,
          });
        }
      } else {
        // r = 0: no interest, just sum contributions
        for (let y = 0; y < years; y++) {
          const monthlyThisYear = monthly * Math.pow(1 + g, y);
          const yearlyContrib = 12 * monthlyThisYear;
          const startingBalance = fv;
          const endingBalance = fv + yearlyContrib;

          // Calculate present value for this year: PV = FV / (1 + inflation_rate)^year
          let presentValue = endingBalance;
          if (inflationRate > 0 && y + 1 > 0) {
            presentValue = endingBalance / Math.pow(1 + inflationRate, y + 1);
          }

          fv = endingBalance;
          totalContributions += yearlyContrib;

          yearlyData.push({
            year: y + 1,
            startingBalance: startingBalance,
            monthlyContribution: monthlyThisYear,
            yearlyContributions: yearlyContrib,
            interestEarned: 0,
            endingBalance: endingBalance,
            presentValue: presentValue,
          });
        }
      }

      const totalInterest = fv - totalContributions;
      const interestShare = fv > 0 ? (totalInterest / fv) * 100 : 0;

      // Calculate present value (purchasing power in today's money)
      // PV = FV / (1 + inflation_rate)^years
      let presentValue = fv;
      if (inflationRate > 0 && years > 0) {
        presentValue = fv / Math.pow(1 + inflationRate, years);
      }

      finalAmountEl.textContent = formatMoney(fv);
      presentValueEl.textContent = formatMoney(presentValue);
      totalContribEl.textContent = formatMoney(totalContributions);
      totalInterestEl.textContent = formatMoney(totalInterest);

      const interestShareText = `${Math.max(0, interestShare).toFixed(1)}%`;
      interestShareEl.textContent = interestShareText;
      interestBarEl.style.width = `${Math.min(100, Math.max(0, interestShare))}%`;

      const labels = translations.breakdownLabels;
      breakdownEl.innerHTML = `
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.principal}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${formatMoney(principal)}</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.monthlyContribution}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${formatMoney(monthly)}</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.depositIncreaseRate}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${depositIncreasePct}%</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.years}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${years}</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.periods}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${periods}</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.annualRate}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${annualRatePct}%</span>
        </div>
        <div class="flex items-center justify-between rounded-md bg-gray-50 px-3 py-2 dark:bg-gray-900">
          <span class="text-sm text-gray-700 dark:text-gray-300">${labels.inflationRate}</span>
          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">${inflationPct}%</span>
        </div>
      `;

      results.classList.remove('hidden');
      exportBtn.classList.remove('hidden');
    }

    // Helper function to export to Excel (using utility pattern)
    async function exportToExcelHelper(options) {
      const { data, filename, sheetName = 'Sheet1', columnWidths, onSuccess, onError } = options;

      try {
        // Dynamic import of xlsx library from CDN
        const XLSX = await import('https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs');

        // Create workbook and worksheet
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Set column widths if provided
        if (columnWidths && columnWidths.length > 0) {
          ws['!cols'] = columnWidths.map((width) => ({ wch: width }));
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);

        // Generate filename with date if not already included
        const dateStr = new Date().toISOString().split('T')[0];
        const finalFilename = filename.includes(dateStr)
          ? `${filename}.xlsx`
          : `${filename}-${dateStr}.xlsx`;

        // Write file
        XLSX.writeFile(wb, finalFilename);

        // Call success callback if provided
        if (onSuccess) {
          onSuccess(finalFilename);
        }
      } catch (error) {
        console.error('Export error:', error);
        const errorMessage = error instanceof Error ? error.message : 'Gagal mengekspor ke Excel';
        if (onError) {
          onError(errorMessage);
        } else {
          throw error;
        }
      }
    }

    function showSuccessNotification(message, duration = 3000) {
      const successMsg = document.createElement('div');
      successMsg.className =
        'fixed bottom-4 right-4 rounded-lg bg-green-500 px-4 py-2 text-white shadow-lg z-50';
      successMsg.textContent = message;
      document.body.appendChild(successMsg);
      setTimeout(() => {
        successMsg.remove();
      }, duration);
    }

    async function handleExportToExcel() {
      if (yearlyData.length === 0) {
        showError(translations.exportError);
        return;
      }

      try {
        // Get column headers from translations
        const headers = [
          translations.exportLabels.year,
          translations.exportLabels.startingBalance,
          translations.exportLabels.monthlyContribution,
          translations.exportLabels.yearlyContributions,
          translations.exportLabels.interestEarned,
          translations.exportLabels.endingBalance,
          translations.exportLabels.presentValue,
        ];

        // Calculate final present value
        const finalBalance = yearlyData[yearlyData.length - 1]?.endingBalance || 0;
        const inflationRate = parseNumber(inflationEl) / 100;
        const years = parseNumber(yearsEl) || 0;
        let finalPresentValue = finalBalance;
        if (inflationRate > 0 && years > 0) {
          finalPresentValue = finalBalance / Math.pow(1 + inflationRate, years);
        }

        // Prepare data for export
        const exportData = [
          [translations.breakdownLabels.principal, formatMoney(parseNumber(principalEl))],
          [translations.breakdownLabels.monthlyContribution, formatMoney(parseNumber(monthlyEl))],
          [
            translations.breakdownLabels.depositIncreaseRate,
            `${parseNumber(depositIncreaseEl) || 0}%`,
          ],
          [translations.breakdownLabels.annualRate, `${parseNumber(rateEl) || 0}%`],
          [translations.breakdownLabels.years, parseNumber(yearsEl) || 0],
          [translations.breakdownLabels.inflationRate, `${parseNumber(inflationEl) || 0}%`],
          [],
          [translations.exportLabels.finalAmount, formatMoney(finalBalance)],
          [translations.exportLabels.presentValue, formatMoney(finalPresentValue)],
          [],
          headers,
        ];

        // Add yearly data with present value calculation
        yearlyData.forEach((data) => {
          const yearsRemaining = years - data.year;
          let presentValue = data.endingBalance;
          if (inflationRate > 0 && yearsRemaining > 0) {
            presentValue = data.endingBalance / Math.pow(1 + inflationRate, yearsRemaining);
          }

          exportData.push([
            data.year,
            formatMoney(data.startingBalance),
            formatMoney(data.monthlyContribution),
            formatMoney(data.yearlyContributions),
            formatMoney(data.interestEarned),
            formatMoney(data.endingBalance),
            formatMoney(presentValue),
          ]);
        });

        // Add summary row
        exportData.push([]);
        const totalContributions = yearlyData.reduce(
          (sum, d) => sum + d.yearlyContributions,
          parseNumber(principalEl)
        );
        const totalInterest = yearlyData.reduce((sum, d) => sum + d.interestEarned, 0);

        exportData.push([
          translations.exportLabels.total,
          '',
          '',
          formatMoney(totalContributions),
          formatMoney(totalInterest),
          formatMoney(finalBalance),
          formatMoney(finalPresentValue),
        ]);

        // Use helper function to export
        await exportToExcelHelper({
          data: exportData,
          filename: 'compound-interest',
          sheetName: 'Compound Interest',
          columnWidths: [10, 20, 20, 25, 20, 20, 25],
          onSuccess: () => {
            showSuccessNotification(translations.exportSuccess);
          },
          onError: () => {
            showError(translations.exportError);
          },
        });
      } catch (error) {
        console.error('Export error:', error);
        showError(translations.exportError);
      }
    }

    function reset() {
      currencyEl.value = 'IDR';
      principalEl.value = '10000000';
      monthlyEl.value = '1000000';
      depositIncreaseEl.value = '7';
      rateEl.value = '10';
      yearsEl.value = '10';
      inflationEl.value = '3';
      hideError();
      results.classList.add('hidden');
      exportBtn.classList.add('hidden');
      yearlyData = [];
      updateHints();
      principalEl.focus();
    }

    currencyEl.addEventListener('change', () => {
      updateHints();
      if (!results.classList.contains('hidden')) calculate();
    });

    for (const el of [principalEl, monthlyEl, depositIncreaseEl, rateEl, yearsEl, inflationEl]) {
      el.addEventListener('input', () => {
        updateHints();
      });
    }

    calcBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', reset);
    exportBtn.addEventListener('click', handleExportToExcel);

    // Enter to calculate
    for (const el of [principalEl, monthlyEl, depositIncreaseEl, rateEl, yearsEl, inflationEl]) {
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          calculate();
        }
      });
    }

    updateHints();
    calculate();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCompoundInterestCalculator);
  } else {
    initCompoundInterestCalculator();
  }
</script>
