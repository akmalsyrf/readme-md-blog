---
import { getTranslations, getLocaleFromPath, getLocalizedPath, type Locale } from '../utils/i18n';
import ThemeToggle from '../components/common/ThemeToggle.astro';
import LanguageSwitcher from '../components/common/LanguageSwitcher.astro';
import SocialLinks from '../components/common/SocialLinks.astro';
import SEO from '../components/common/SEO.astro';
import StructuredData from '../components/common/StructuredData.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  tags = [],
} = Astro.props;
const currentPath = Astro.url.pathname;
const locale = getLocaleFromPath(currentPath);
const t = getTranslations(locale);

const pageTitle = title ? `${title} - ${t.site.title}` : t.site.title;
const pageDescription = description || t.site.description;

// Generate alternate locales
const alternateLocales: Array<{ locale: Locale; url: string }> = [];
if (locale === 'id') {
  alternateLocales.push({
    locale: 'en',
    url: getLocalizedPath(currentPath, 'en'),
  });
} else {
  alternateLocales.push({
    locale: 'id',
    url: getLocalizedPath(currentPath.replace('/en', ''), 'id'),
  });
}
---

<!doctype html>
<html lang={locale} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>

    <SEO
      title={pageTitle}
      description={pageDescription}
      canonicalURL={Astro.url}
      image={image}
      type={type}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      author={author}
      tags={tags}
      locale={locale}
      alternateLocales={alternateLocales}
      siteName={t.site.title}
    />

    <StructuredData
      type={type === 'article' ? 'Article' : 'WebSite'}
      title={pageTitle}
      description={pageDescription}
      url={Astro.url.href}
      image={image}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      author={author ? { name: author } : undefined}
      siteName={t.site.title}
      siteURL={Astro.site?.href}
      locale={locale === 'id' ? 'id-ID' : 'en-US'}
      alternateLocales={alternateLocales.map((alt) => ({
        locale: alt.locale === 'id' ? 'id-ID' : 'en-US',
        url: alt.url,
      }))}
    />
    <!-- Blocking script to prevent flash of light theme - must run before render -->
    <script is:inline>
      (function () {
        // Get theme from localStorage or default to system preference
        const storedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = storedTheme || (prefersDark ? 'dark' : 'light');

        // Apply theme immediately before any rendering
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }

        // Mark theme as loaded after a short delay to enable transitions
        requestAnimationFrame(function () {
          requestAnimationFrame(function () {
            document.documentElement.classList.add('theme-loaded');
          });
        });
      })();
    </script>
  </head>
  <body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <header
      class="sticky top-0 z-50 border-b border-gray-200/80 bg-white/80 backdrop-blur-md dark:border-gray-800/80 dark:bg-gray-900/80"
    >
      <div class="container mx-auto px-4 py-3">
        <nav class="flex items-center justify-between">
          <div class="flex items-center gap-4 md:gap-8">
            <a
              href={locale === 'id' ? '/' : '/en'}
              class="text-lg font-semibold tracking-tight text-gray-900 transition-colors duration-200 hover:text-gray-700 dark:text-gray-100 dark:hover:text-gray-300 md:text-xl"
            >
              {t.site.title}
            </a>
            <div class="hidden items-center gap-1 md:flex">
              <a
                href={locale === 'id' ? '/notes' : '/en/notes'}
                class="relative rounded-lg px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100"
              >
                {t.nav.notes}
              </a>
              <a
                href={locale === 'id' ? '/archive' : '/en/archive'}
                class="relative rounded-lg px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100"
              >
                {t.nav.archive}
              </a>
              <a
                href={locale === 'id' ? '/search' : '/en/search'}
                class="relative rounded-lg px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100"
              >
                {t.nav.search}
              </a>
              <a
                href={locale === 'id' ? '/tags' : '/en/tags'}
                class="relative rounded-lg px-3 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-gray-100"
              >
                {t.nav.tags}
              </a>
            </div>
          </div>
          <div class="flex items-center gap-2 md:gap-3">
            <div class="hidden md:block">
              <LanguageSwitcher currentLocale={locale} currentPath={currentPath} />
            </div>
            <div class="hidden md:block">
              <ThemeToggle locale={locale} />
            </div>
            <button
              id="mobile-menu-button"
              class="touch-manipulation rounded-lg p-2.5 text-gray-700 transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800 md:hidden"
              aria-label="Toggle menu"
              aria-expanded="false"
            >
              <svg
                id="mobile-menu-icon-open"
                class="h-6 w-6 transition-opacity duration-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
              <svg
                id="mobile-menu-icon-close"
                class="hidden h-6 w-6 transition-opacity duration-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </nav>
        <!-- Mobile Menu -->
        <div
          id="mobile-menu"
          class="mobile-menu hidden overflow-hidden transition-all duration-300 ease-in-out md:hidden"
        >
          <div class="border-t border-gray-200 pb-4 pt-4 dark:border-gray-800">
            <div class="flex flex-col gap-1">
              <a
                href={locale === 'id' ? '/notes' : '/en/notes'}
                class="mobile-menu-link touch-manipulation rounded-lg px-4 py-3 text-base font-medium text-gray-700 transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800"
              >
                {t.nav.notes}
              </a>
              <a
                href={locale === 'id' ? '/archive' : '/en/archive'}
                class="mobile-menu-link touch-manipulation rounded-lg px-4 py-3 text-base font-medium text-gray-700 transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800"
              >
                {t.nav.archive}
              </a>
              <a
                href={locale === 'id' ? '/search' : '/en/search'}
                class="mobile-menu-link touch-manipulation rounded-lg px-4 py-3 text-base font-medium text-gray-700 transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800"
              >
                {t.nav.search}
              </a>
              <a
                href={locale === 'id' ? '/tags' : '/en/tags'}
                class="mobile-menu-link touch-manipulation rounded-lg px-4 py-3 text-base font-medium text-gray-700 transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800"
              >
                {t.nav.tags}
              </a>
            </div>
            <div class="mt-4 border-t border-gray-200 pt-4 dark:border-gray-800">
              <div class="mb-3">
                <p class="mb-2 text-xs font-medium text-gray-500 dark:text-gray-400">Language</p>
                <LanguageSwitcher currentLocale={locale} currentPath={currentPath} />
              </div>
              <div>
                <p class="mb-2 text-xs font-medium text-gray-500 dark:text-gray-400">Theme</p>
                <ThemeToggle locale={locale} />
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main id="main-content" class="page-transition">
      <slot />
    </main>

    <footer class="mt-16 border-t border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-900">
      <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col items-center gap-4 text-center">
          <SocialLinks />
          <p class="text-gray-600 dark:text-gray-400">
            &copy; {new Date().getFullYear()}
            {t.site.title}. All rights reserved.
          </p>
        </div>
      </div>
    </footer>
  </body><script>
    // Mobile menu toggle with animations
    (function () {
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileMenuIconOpen = document.getElementById('mobile-menu-icon-open');
      const mobileMenuIconClose = document.getElementById('mobile-menu-icon-close');

      if (!mobileMenuButton || !mobileMenu || !mobileMenuIconOpen || !mobileMenuIconClose) return;

      function toggleMenu() {
        const isOpen = !mobileMenu.classList.contains('hidden');

        if (isOpen) {
          // Close menu
          mobileMenu.classList.add('hidden');
          mobileMenu.classList.remove('mobile-menu-open');
          mobileMenuButton.setAttribute('aria-expanded', 'false');
          mobileMenuIconOpen.classList.remove('hidden');
          mobileMenuIconClose.classList.add('hidden');
          document.body.classList.remove('menu-open');
        } else {
          // Open menu
          mobileMenu.classList.remove('hidden');
          // Trigger animation on next frame
          requestAnimationFrame(() => {
            mobileMenu.classList.add('mobile-menu-open');
          });
          mobileMenuButton.setAttribute('aria-expanded', 'true');
          mobileMenuIconOpen.classList.add('hidden');
          mobileMenuIconClose.classList.remove('hidden');
          document.body.classList.add('menu-open');
        }
      }

      mobileMenuButton.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu();
      });

      // Close menu when clicking on a link
      const mobileMenuLinks = mobileMenu.querySelectorAll('.mobile-menu-link');
      mobileMenuLinks.forEach((link) => {
        link.addEventListener('click', () => {
          // Small delay to allow navigation
          setTimeout(() => {
            toggleMenu();
          }, 100);
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (
          !mobileMenu.contains(target) &&
          !mobileMenuButton.contains(target) &&
          !mobileMenu.classList.contains('hidden')
        ) {
          toggleMenu();
        }
      });

      // Close menu on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          toggleMenu();
        }
      });

      // Close menu on resize to desktop
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && !mobileMenu.classList.contains('hidden')) {
          toggleMenu();
        }
      });
    })();

    // Page transition animation
    (function () {
      const mainContent = document.getElementById('main-content');

      // Add fade-in animation on initial page load
      if (mainContent) {
        // Small delay to ensure smooth initial load
        requestAnimationFrame(() => {
          mainContent.classList.add('page-enter');
        });
      }

      // Handle Astro view transitions (if enabled)
      if (document.startViewTransition) {
        // Use native view transitions API if available
        document.addEventListener('astro:before-preparation', () => {
          if (mainContent) {
            mainContent.classList.add('page-exit');
          }
        });

        document.addEventListener('astro:page-load', () => {
          if (mainContent) {
            mainContent.classList.remove('page-exit');
            requestAnimationFrame(() => {
              mainContent.classList.add('page-enter');
            });
          }
        });
      } else {
        // Fallback for browsers without view transitions
        document.addEventListener('astro:page-load', () => {
          if (mainContent) {
            mainContent.classList.remove('page-enter', 'page-exit');
            // Trigger reflow to restart animation
            void mainContent.offsetWidth;
            requestAnimationFrame(() => {
              mainContent.classList.add('page-enter');
            });
          }
        });

        document.addEventListener('astro:before-preparation', () => {
          if (mainContent) {
            mainContent.classList.add('page-exit');
          }
        });
      }
    })();
  </script>

  <style is:global>
    html {
      font-family: system-ui, sans-serif;
    }

    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      @apply bg-gray-100 dark:bg-gray-800;
    }

    ::-webkit-scrollbar-thumb {
      @apply rounded-full bg-gray-300 dark:bg-gray-600;
    }

    ::-webkit-scrollbar-thumb:hover {
      @apply bg-gray-400 dark:bg-gray-500;
    }

    /* Page Transition Animations */
    .page-transition {
      opacity: 0;
      will-change: opacity, transform;
    }

    .page-enter {
      animation: pageFadeIn 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .page-exit {
      animation: pageFadeOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes pageFadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pageFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-8px);
      }
    }

    /* Smooth transitions for theme changes - but NOT on initial page load to prevent flash */
    body,
    body * {
      transition-property: background-color, border-color, color, fill, stroke, box-shadow;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }

    /* Disable transitions on initial load to prevent flash */
    html:not(.theme-loaded) body,
    html:not(.theme-loaded) body * {
      transition: none !important;
    }

    /* Mark theme as loaded after initial render */
    html.theme-loaded body,
    html.theme-loaded body * {
      transition-property: background-color, border-color, color, fill, stroke, box-shadow;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
    }

    /* Prevent animation on initial page load for better performance */
    @media (prefers-reduced-motion: reduce) {
      .page-transition,
      .page-enter,
      .page-exit {
        animation: none !important;
        opacity: 1 !important;
        transform: none !important;
      }
    }

    /* Optimize animations for better performance */
    .page-transition,
    .page-enter,
    .page-exit {
      backface-visibility: hidden;
      perspective: 1000px;
    }

    /* Mobile Menu Styles */
    .mobile-menu {
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
    }

    .mobile-menu.mobile-menu-open {
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }

    /* Better touch targets for mobile */
    .touch-manipulation {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Smooth transitions for mobile menu */
    .mobile-menu-link {
      min-height: 44px; /* Minimum touch target size */
      display: flex;
      align-items: center;
    }

    /* Prevent body scroll when menu is open on mobile */
    @media (max-width: 767px) {
      body.menu-open {
        overflow: hidden;
      }
    }
  </style>
</html>
