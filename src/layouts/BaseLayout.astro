---
import { getLocaleFromPath, getTranslations } from '../utils/i18n';
import Head from '../components/layout/Head.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import LayoutScripts from '../components/layout/LayoutScripts.astro';
import LayoutStyles from '../components/layout/LayoutStyles.astro';
import ChatBot from '../components/chat/ChatBot.astro';
import ImageModal from '../components/common/ImageModal.astro';
import DeepResearchReportCanvas from '../components/others/DeepResearch/DeepResearchReportCanvas.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  publishedTime?: Date;
  modifiedTime?: Date;
  author?: string;
  tags?: string[];
}

const {
  title,
  description,
  image,
  type = 'website',
  publishedTime,
  modifiedTime,
  author,
  tags = [],
} = Astro.props;
const currentPath = Astro.url.pathname;
const locale = getLocaleFromPath(currentPath);
const t = getTranslations(locale);
---

<!doctype html>
<html lang={locale} class="scroll-smooth">
  <head>
    <Head
      title={title}
      description={description}
      image={image}
      type={type}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      author={author}
      tags={tags}
      currentPath={currentPath}
      locale={locale}
    />
  </head>
  <body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <Header locale={locale} currentPath={currentPath} />

    <main id="main-content" class="page-transition">
      <slot />
    </main>

    <Footer locale={locale} />

    <LayoutScripts />
    <LayoutStyles />

    <ChatBot locale={locale} />
    <ImageModal />
    <DeepResearchReportCanvas locale={locale} t={t} />

    <!-- Initialize vector store on page load -->
    <script define:vars={{ locale }}>
      // Initialize vector store in the background when page loads
      // This pre-initializes the vector store so chat doesn't have to wait
      (function () {
        // Only run once per page load
        if (window.__vectorStoreInitStarted) return;
        window.__vectorStoreInitStarted = true;

        // Call init-vectors API silently in the background
        fetch('/api/init-vectors', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ locale }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Do nothing
            }
          })
          // eslint-disable-next-line no-unused-vars
          .catch((error) => {
            // Do nothing
          });
      })();
    </script>
  </body>
</html>
