---
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import { getTranslations, getLocaleFromPath, getLocalizedPath } from '../../../../../utils/i18n';
import { getCheatsheetCategoryPaginationStaticPaths } from '../../../../../utils/getCheatsheetCategoryPaginationStaticPaths';
import { getCheatsheetsForCategory } from '../../../../../utils/getCheatsheetsByCategory';
import Pagination from '../../../../../components/common/Pagination.astro';
import { CHEATSHEETS_PER_PAGE } from '../../../../../config/cheatsheet';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  return await getCheatsheetCategoryPaginationStaticPaths();
}

interface Props {
  category: string;
  page: string;
}

const { category, page } = Astro.params;
// Astro automatically decodes URL params, so category is already decoded
const currentPage = parseInt(page || '1', 10);

const currentPath = Astro.url.pathname;
const locale = getLocaleFromPath(currentPath);
const t = getTranslations(locale);

// Get cheatsheets for this category
const allCheatsheets = await getCheatsheetsForCategory(category);
const totalPages = Math.ceil(allCheatsheets.length / CHEATSHEETS_PER_PAGE);

// Redirect to first page if page number is invalid
if (currentPage < 1 || currentPage > totalPages) {
  return Astro.redirect(getLocalizedPath(`/cheatsheet/category/${encodeURI(category)}`, locale));
}

// Get posts for current page
const startIndex = (currentPage - 1) * CHEATSHEETS_PER_PAGE;
const paginatedCheatsheets = allCheatsheets.slice(startIndex, startIndex + CHEATSHEETS_PER_PAGE);

// Use encodeURI to properly encode the category in URLs
const basePath = `/cheatsheet/category/${encodeURI(category)}`;
---

<BaseLayout title={`${category} - ${t.cheatsheet.title}`} description={t.site.description}>
  <div class="container mx-auto px-4 py-12">
    <div class="mx-auto max-w-4xl">
      <h1 class="mb-6 text-4xl font-bold">{category}</h1>
      <p class="mb-8 text-gray-600 dark:text-gray-400">
        {allCheatsheets.length}
        {
          locale === 'id'
            ? 'cheatsheet'
            : allCheatsheets.length === 1
              ? 'cheatsheet'
              : 'cheatsheets'
        }
      </p>

      {
        paginatedCheatsheets.length > 0 ? (
          <>
            <div class="grid gap-6 md:grid-cols-2">
              {paginatedCheatsheets.map((cheatsheet: CollectionEntry<'cheatsheet'>) => (
                <article class="rounded-lg border border-gray-200 bg-white p-6 transition-shadow hover:shadow-lg dark:border-gray-800 dark:bg-gray-800">
                  <h2 class="mb-2 text-xl font-semibold">
                    <a
                      href={`/cheatsheet/${cheatsheet.slug}`}
                      class="hover:text-blue-600 dark:hover:text-blue-400"
                    >
                      {cheatsheet.data.title}
                    </a>
                  </h2>
                  <p class="mb-4 text-gray-600 dark:text-gray-400">{cheatsheet.data.description}</p>
                  <div class="mb-4 flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                    <time>
                      {cheatsheet.data.pubDate.toLocaleDateString(
                        locale === 'id' ? 'id-ID' : 'en-US',
                        {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                        }
                      )}
                    </time>
                  </div>
                  <div class="flex items-center justify-end">
                    <a
                      href={`/cheatsheet/${cheatsheet.slug}`}
                      class="text-sm font-medium text-blue-600 hover:underline dark:text-blue-400"
                    >
                      {t.cheatsheet.readMore} â†’
                    </a>
                  </div>
                  {cheatsheet.data.tags && cheatsheet.data.tags.length > 0 && (
                    <div class="mt-4 flex flex-wrap gap-2">
                      {cheatsheet.data.tags.map((tag: string) => (
                        <span class="rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                          {tag}
                        </span>
                      ))}
                    </div>
                  )}
                </article>
              ))}
            </div>
            {/* Pagination */}
            {totalPages > 1 && (
              <Pagination
                currentPage={currentPage}
                totalPages={totalPages}
                basePath={basePath}
                locale={locale}
                translations={t}
              />
            )}
          </>
        ) : (
          <p class="text-gray-600 dark:text-gray-400">{t.cheatsheet.noCheatsheets}</p>
        )
      }
    </div>
  </div>
</BaseLayout>
